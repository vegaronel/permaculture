<%- include("partials/UserHeader.ejs") %>

<style>
    .card {
    border-radius: 20px;
    border: none;
    background: #e2f0fb;
}

.percentage {
    font-size: 48px;
    color: #fff;
}

.status-text {
    font-size: 16px;
    padding: 5px 10px;
}

.action-text {
    font-size: 14px;
    color: #a6b1be;
}

</style>
<!-- Page Content -->
<div class="container-fluid hidden-scroll"> 

    <section class="weather-section">
        <div class="row nexa-black gap-4 d-flex justify-content-center m-2">
            <div class="col-lg-7 d-flex gap-3 flex-column">
                <div class="p-4 center-items weather-card b-radius-50">
                    <div>
                        <div class="d-flex align-items-center">
                            <img src="images/location-icon.svg" alt="">
                            <p class="h2 fs-30 m-0">Vinzons, Camarines Norte</p>
                        </div>
                        <p class="arial fs-14"><strong><%= day %>,</strong>  <%= dateToday %></p>
                        <p class="fs-80"><%= weather.main.temp %>°</p>
                    </div>
                    <div>
                        <img class="weather-icon-lg" src="images/weather-icons/<%= weather.weather[0].main %>.svg" alt="">
                    </div>
                </div>

                <div class="arial p-4 weather-card b-radius-50">
                    <div class="p-3">
                        <h3>5-Day Forecast</h3>
                    </div>
                    <div class="px-2 overflow-x-auto">                
                        <div class="forecast-container d-flex justify-content-around">
                            <% forecast.forEach(day => { %>
                                <div class="forecast-day d-flex justify-content-center flex-column align-items-center">
                                    <p><%= new Date(day.dt_txt).toLocaleDateString('en-US', { weekday: 'long' }) %></p>
                                    <img src="https://openweathermap.org/img/wn/<%= day.weather[0].icon %>@2x.png" alt="Weather Icon">
                                    <p><%= day.main.temp %> °C</p>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 p-4 weather-card b-radius-50">
                <div class="d-flex align-items-center">
                    <img src="/images/todo-icon.svg" alt="">
                    <p class="m-0 gray-text todo-text">To do list</p>
                </div>
                <div class="px-4">
                    <!-- needs to do -->
                </div>
            </div>
        </div>    
    </section>

    <section id="my-plants">
        <div class="row gap-4 mt-3 d-flex justify-content-center mx-2">
            <div class="col-lg-7 col-md-12 d-flex gap-3 flex-column">
                <div class="col p-4 weather-card b-radius-50 ">
                    <p class="h5">Plants That Need to Be Watered</p>
                    <% if(locals.plant) { %>
                        <div class="container-water d-flex gap-3">
                            <% plants.filter(plant => plant.needsWatering).forEach(plant => { %>
                                <div class="not-watered-plants">
                                    <%= plant.name %>
                                    <form action="/water-plant/<%= plant._id %>" method="POST" style="display: inline">
                                        <button type="submit" class="btn btn-success btn-sm ml-2">Water</button>
                                    </form>
                                    <p style="width: 300px;">Last Watered: <%= plant.lastWatered ? new Date(plant.lastWatered).toLocaleDateString() : 'Not yet watered' %></p>
                                </div>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <p>Nice, all plants are hydrated.</p>
                    <% } %>

                    <div class="d-flex align-items-center mt-2">
                        <img src="/images/my-plants.svg" alt="">
                        <p class="h5 m-0">My Plants</p>
                    </div>

                    <div class="table-responsive">
                        <% if (plants && plants.length > 0) { %>
                            <table id="plantsTable" class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Plant Name</th>
                                        <th>Location</th>
                                        <th>Estimated Harvest Time</th>
                                        <th>Current Stage</th>
                                        <th>Verify Stage</th> <!-- New column for verification -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <% plants.forEach(plant => { %>
                                        <tr>
                                            <td><%= plant.customId %></td>
                                            <td><%= plant.name %></td>
                                            <td><%= plant.location %></td>
                                            <td><%= new Date(plant.estimatedHarvestTime).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) %></td>
                                            <td><%= plant.growthStage && plant.growthStage.trim() !== '' ? plant.growthStage : plant.computedGrowthStage %></td>
                                            <td>
                                                <form action="/update-growth-stage/<%= plant._id %>" method="POST">
                                                    <label class="form-label" for="userGrowthStage">Is this stage accurate?</label>
                                                    <div class="d-flex">
                                                        <select class="form-control" name="userGrowthStage" id="userGrowthStage">
                                                            <option value="sprout">Sprout</option>
                                                            <option value="seedling">Seedling</option>
                                                            <option value="vegetating">Vegetating</option>
                                                            <option value="budding">Budding</option>
                                                            <option value="flowering">Flowering</option>
                                                            <option value="ripening">Ripening</option>
                                                            <option value="harvesting">Harvesting</option>
                                                        </select>
                                                        <button type="submit" class="btn btn-primary btn-sm">Update</button>
                                                    </div>
                                                </form>
                                            </td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        <% } else { %>
                            <p>No plants found. Start by adding a new plant!</p>
                        <% } %>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-12 p-4 weather-card b-radius-50">
                <h5>Soil Moisture Data</h5>
                <div id="soilMoistureContainer" style="overflow: scroll; height: 370px;" class="d-flex flex-column"></div>
            </div>
        </div>    
    </section>

</div>
<!-- /#page-content-wrapper -->
</div>
<%- include("partials/UserFooter.ejs") %>
<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const userId = '<%= userId %>'; // Get the userId from the server-side render
    socket.on('soilMoistureUpdate', (data) => {
    const $container = $('#soilMoistureContainer');
    if (!$container.length) return;

    $.each(data, (sensorId, sensorData) => {
        if (sensorData.userId === userId) {
            const moistureValue = sensorData.moistureValue;
            const locDat = sensorData.locationName;

            let statusText;
            let statusClass = '';

            // Define status and status class based on moisture value
            if (moistureValue < 30) {
                statusText = 'Soil is Dry';
                statusClass = 'text-white';
            } else if (moistureValue < 45) {
                statusText = 'Soil is Moist';
                statusClass = 'text-white';
            } else if (moistureValue < 60) {
                statusText = 'Soil is Damp';
                statusClass = 'text-white';
            } else {
                statusText = 'Soil is Wet';
                statusClass = 'text-white';
            }

            let $card = $container.find(`.card[data-location="${locDat}"]`);

            if ($card.length) {
                // Update the percentage, status text, and background gradient
                $card.find('.percentage').text(`${moistureValue}%`);
                $card.find('.status-text').text(statusText);
                $card.find('.status-text').attr('class', `status-text ${statusClass}`); // Update the text class
                $card.css('background', `linear-gradient(${getGradient(moistureValue)})`); // Update the background
            } else {
                // Create a new card with the proper gradient and text class
                $card = $(`
                    <div class="card mb-3 p-4 shadow-none" data-location="${locDat}" style="border-radius: 20px; background: linear-gradient(${getGradient(moistureValue)});">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="location-name mb-2">${locDat}</h5>
                                <p class="action-text text-muted">No Action Needed</p>
                            </div>
                            <div class="d-flex flex-column justify-content-center">
                                <h1 class="percentage" style="font-weight: bold; color: #fff;">${moistureValue}%</h1>
                                <span class="status-text ${statusClass}" style="font-size: 16px;">${statusText}</span>
                            </div>
                        </div>
                    </div>
                `);

                $container.append($card);
            }

            // Smooth update animation
            $card.find('.percentage').css({
                'transition': 'all 1s ease-in-out'
            });
        }
    });
});




function getGradient(moistureValue) {
    if (moistureValue < 30) {
        return 'to bottom right, rgba(220, 53, 69, 1) 35%, rgba(255, 255, 255, 0) 100%';
    } else if (moistureValue < 45) {
        return 'to bottom right, rgba(255, 193, 7, 1) 35%, rgba(255, 255, 255, 0) 100%'; 
    } else if (moistureValue < 60) {
        return 'to bottom right, rgba(67, 181, 229, 1) 35%, rgba(255, 255, 255, 0) 100%'; 
    } else {
        return 'to bottom right, rgba(40, 167, 69, 1) 35%, rgba(255, 255, 255, 0) 100%'; 
    }
}

</script>
