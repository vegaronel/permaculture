<%- include("partials/UserHeader.ejs") %>

<!-- Page Content -->
<div class="container-fluid hidden-scroll"> 

    <section class="weather-section">
        <div class="row nexa-black gap-4 d-flex justify-content-center m-2">
            <div class="col-lg-7 d-flex gap-3 flex-column">
                <div class="p-4 center-items weather-card b-radius-50">
                    <div>
                        <div class="d-flex align-items-center">
                            <img src="images/location-icon.svg" alt="">
                            <p class="h2 fs-30 m-0">Vinzons, Camarines Norte</p>
                        </div>
                        <p class="arial fs-14"><strong><%= day %>,</strong>  <%= dateToday %></p>
                        <p class="fs-80"><%= weather.main.temp %>°</p>
                    </div>
                    <div>
                        <img class="weather-icon-lg" src="images/weather-icons/<%= weather.weather[0].main %>.svg" alt="">
                    </div>
                </div>

                <div class="arial p-4 weather-card b-radius-50">
                    <div class="p-3">
                        <h3>5-Day Forecast</h3>
                    </div>
                    <div class="px-2 overflow-x-auto">                
                        <div class="forecast-container d-flex justify-content-around">
                            <% forecast.forEach(day => { %>
                                <div class="forecast-day d-flex justify-content-center flex-column align-items-center">
                                    <p><%= new Date(day.dt_txt).toLocaleDateString('en-US', { weekday: 'long' }) %></p>
                                    <img src="https://openweathermap.org/img/wn/<%= day.weather[0].icon %>@2x.png" alt="Weather Icon">
                                    <p><%= day.main.temp %> °C</p>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 p-4 weather-card b-radius-50">
                <div class="d-flex align-items-center">
                    <img src="/images/todo-icon.svg" alt="">
                    <p class="m-0 gray-text todo-text">To do list</p>
                </div>
                <div class="px-4">
                    <p>askdjhaksdksajhd</p>
                    <p>askdjhaksdksajhd</p>
                    <p>askdjhaksdksajhd</p>
                </div>
            </div>
        </div>    
    </section>

    <section id="my-plants">
        <div class="row gap-4 mt-3 d-flex justify-content-center mx-2">
            <div class="col-lg-7 col-md-12 d-flex gap-3 flex-column">
                <div class="col p-4 weather-card b-radius-50 ">
                    <p class="h5">Plants That Need to Be Watered</p>
                    <% if(locals.plant) { %>
                        <div class="container-water d-flex gap-3">
                            <% plants.filter(plant => plant.needsWatering).forEach(plant => { %>
                                <div class="not-watered-plants">
                                    <%= plant.name %>
                                    <form action="/water-plant/<%= plant._id %>" method="POST" style="display: inline">
                                        <button type="submit" class="btn btn-success btn-sm ml-2">Water</button>
                                    </form>
                                    <p style="width: 300px;">Last Watered: <%= plant.lastWatered ? new Date(plant.lastWatered).toLocaleDateString() : 'Not yet watered' %></p>
                                </div>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <p>Nice, all plants are hydrated.</p>
                    <% } %>

                    <div class="d-flex align-items-center mt-2">
                        <img src="/images/my-plants.svg" alt="">
                        <p class="h5 m-0">My Plants</p>
                    </div>

                    <div class="table-responsive">
                        <% if (plants && plants.length > 0) { %>
                            <table id="plantsTable" class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Plant Name</th>
                                        <th>Location</th>
                                        <th>Estimated Harvest Time</th>
                                        <th>Current Stage</th>
                                        <th>Verify Stage</th> <!-- New column for verification -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <% plants.forEach(plant => { %>
                                        <tr>
                                            <td><%= plant.customId %></td>
                                            <td><%= plant.name %></td>
                                            <td><%= plant.location %></td>
                                            <td><%= new Date(plant.estimatedHarvestTime).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) %></td>
                                            <td><%= plant.growthStage && plant.growthStage.trim() !== '' ? plant.growthStage : plant.computedGrowthStage %></td>
                                            <td>
                                                <form action="/update-growth-stage/<%= plant._id %>" method="POST">
                                                    <label class="form-label" for="userGrowthStage">Is this stage accurate?</label>
                                                    <div class="d-flex">
                                                        <select class="form-control" name="userGrowthStage" id="userGrowthStage">
                                                            <option value="sprout">Sprout</option>
                                                            <option value="seedling">Seedling</option>
                                                            <option value="vegetating">Vegetating</option>
                                                            <option value="budding">Budding</option>
                                                            <option value="flowering">Flowering</option>
                                                            <option value="ripening">Ripening</option>
                                                            <option value="harvesting">Harvesting</option>
                                                        </select>
                                                        <button type="submit" class="btn btn-primary btn-sm">Update</button>
                                                    </div>
                                                </form>
                                            </td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        <% } else { %>
                            <p>No plants found. Start by adding a new plant!</p>
                        <% } %>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-12 p-4 weather-card b-radius-50">
                <h5>Soil Moisture Data</h5>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Location</th>
                            <th>Moisture Level</th>
                            <th>Status</th> <!-- New Status Column -->
                        </tr>
                    </thead>
                    <tbody id="soilMoistureTableBody">
                       
                    </tbody>
                </table>
            </div>
        </div>    
    </section>

</div>
<!-- /#page-content-wrapper -->
</div>
<%- include("partials/UserFooter.ejs") %>
<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io(); // Ensure this line is present
    socket.on('soilMoistureUpdate', (data) => {
      const tableBody = document.getElementById('soilMoistureTableBody');
      if (!tableBody) return;
  
      Object.keys(data).forEach(sensorId => {
          const moistureValue = data[sensorId].moistureValue;
          const locDat = data[sensorId].locationName;
          let row = tableBody.querySelector(`tr[data-location="${locDat}"]`);
  
          // Determine status based on moistureValue
          let statusText;
          let progressClass = ''; // Class for progress bar
          let textClass = ''; // Class for text status
  
          if (moistureValue < 30) {
              statusText = 'Dry';
              progressClass = 'bg-danger';
              textClass = 'text-danger';
          } else if (moistureValue < 45) {
              statusText = 'Moist';
              progressClass = 'bg-warning';
              textClass = 'text-warning';
          } else if (moistureValue < 60) {
              statusText = 'Moderate';
              progressClass = 'bg-info'; // Using info color for moderate
              textClass = 'text-info';
          } else {
              statusText = 'Wet';
              progressClass = 'bg-success';
              textClass = 'text-success';
          }
  
          if (!row) {
              // Create a new row if it doesn't exist
              row = document.createElement('tr');
              row.setAttribute('data-location', locDat);
              row.innerHTML = `
                  <td>${locDat}</td>
                  <td>
                      <div class="progress" style="height: 20px;">
                          <div class="progress-bar ${progressClass}" 
                               role="progressbar" 
                               style="width: ${moistureValue}%;"
                               aria-valuenow="${moistureValue}" 
                               aria-valuemin="0" 
                               aria-valuemax="100">
                              ${moistureValue}%
                          </div>
                      </div>
                  </td>
                  <td>
                      <p class="${textClass}">${statusText}</p>
                  </td>
              `;
              tableBody.appendChild(row);
          } else {
              // Update existing row
              const progressBar = row.querySelector('.progress-bar');
              progressBar.style.width = `${moistureValue}%`;
              progressBar.setAttribute('aria-valuenow', moistureValue);
              progressBar.textContent = `${moistureValue}%`;
              progressBar.className = `progress-bar ${progressClass}`; // Update class
  
              // Update the status text
              const statusParagraph = row.querySelector('td p');
              statusParagraph.textContent = statusText; // Update status text
              statusParagraph.className = textClass; // Update text class
          }
      });
  });
  </script>
  