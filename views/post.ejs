<%- include("partials/UserHeader.ejs") %>

<div class="container-fluid hidden-scroll"> 

    <div class="card mb-4 shadow-sm bg-white rounded-lg">
        <div class="card-body d-flex align-items-start">          
          <!-- Post Content -->
          <div class="flex-grow-1">
            <p><%= post.userId.firstname %> <%= post.userId.lastname %> <small> <strong><%= post.category %></strong></small></p>
            <p><%= post.createdAt.toLocaleString() %></p>
            <p> <%= post.content %></p>
            <% if (post.image) { %>
                <img src="<%= post.image %>" alt="Post Image" style="max-width: 100%; height: auto;" />
            <% } %>
          </div>
        </div>
        <div class="shadow-sm bg-primary rounded-lg">
            <h2>Comments</h2>
            <div id="comments">
                <!-- Comments will be dynamically loaded here -->
            </div>
            <button id="showMore" class="btn btn-primary" style="display: none;">Show More Comments</button>
            
            <form id="commentForm" action="/comment/<%= post._id %>" method="POST">
                <input type="text" name="comment" required placeholder="Add a comment...">
                <button type="submit">Comment</button>
            </form>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        let page = 1;
        const postId = '<%= post._id %>';

        // Function to load comments
        function loadComments() {
            $.ajax({
                url: `/comments/${postId}?page=${page}&limit=10`,
                type: 'GET',
                success: function(comments) {
                    if (comments.length > 0) {
                        comments.forEach(comment => {
                            $('#comments').append(`
                                <div class="comment">
                                    <p><strong>${comment.userId.firstname} ${comment.userId.lastname}:</strong> ${comment.comment}</p>
                                    <p>Commented at: ${new Date(comment.createdAt).toLocaleString()}</p>
                                </div>
                            `);
                        });

                        // Show the "Show More" button if we got 10 comments (meaning there might be more)
                        if (comments.length === 10) {
                            $('#showMore').show();
                        } else {
                            $('#showMore').hide();
                        }
                    } else {
                        $('#showMore').hide();
                    }
                },
                error: function(error) {
                    console.error('Error loading comments:', error);
                }
            });
        }

        // Initial load of comments
        loadComments();

        // "Show More Comments" button click event
        $('#showMore').on('click', function() {
            page++;
            loadComments();
        });

        // Submit a new comment using AJAX
        $('#commentForm').on('submit', function(e) {
            e.preventDefault(); // Prevent the default form submission
            
            const comment = $('input[name="comment"]').val();
            
            $.ajax({
                url: `/comment/${postId}`,
                type: 'POST',
                data: { comment: comment },
                success: function(response) {
                    $('#comments').prepend(`
                        <div class="comment">
                            <p><strong>${response.user.firstname} ${response.user.lastname}:</strong> ${response.comment.comment}</p>
                            <p>Commented at: ${new Date(response.comment.createdAt).toLocaleString()}</p>
                        </div>
                    `);
                    $('input[name="comment"]').val(''); // Clear the input field
                },
                error: function(error) {
                    console.error('Error adding comment:', error);
                }
            });
        });
    });
</script>

<%- include("partials/UserFooter.ejs") %>
