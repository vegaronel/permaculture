<%- include("partials/UserHeader.ejs") %>

<div id="page-content-wrapper">
    <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
        <button id="menu-toggle" class="btn">
            <i class="fas fa-bars" id="menuIcon"></i>
        </button>
        <p class="m-0">Community</p>

    </nav>

<div class="container">

        <div id="comments">
            <!-- Comments will be loaded here -->
        </div>
        
        <form id="commentForm">
            <div class="form-group">
                <input hidden type="text" class="form-control" id="username" name="username" 
                
                <% if (locals.username) { %>
                      value="<%= username %>">
                <% } %>
                <input hidden id="profilePicture" type="text" name="profilePicture" 
                <% if(locals.profilePicture){ %>
                    value="<%= profilePicture %>"
                <%} %>>
            </div>
            <div class="form-group">
                <label for="content">Comment</label>
                <textarea class="form-control" id="content" name="content" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>
   
</main>


<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const loadComments = async () => {
            try {
                const response = await fetch('/comments');
                const comments = await response.json();
                const commentsDiv = document.getElementById('comments');
                commentsDiv.innerHTML = '';
                comments.forEach(comment => {
                    const commentElement = document.createElement('div');
                    commentElement.classList.add('comment');           
                    commentElement.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="community-profile">
                            <img class="communityProfile rounded-circle" src="${comment.profilePicture}" alt="" width="40" height="40">
                        </div>
                            <h5 class="text-primary px-2">${comment.username}</h5>
                        </div>
                        <div class="">
                            <p class = "mt-4">${comment.content}</p>
                        </div>
                         <small class = "text-primary">${new Date(comment.createdAt).toLocaleString()}</small>
                            <hr>
                    `;
                    commentsDiv.prepend(commentElement);
                });
            } catch (err) {
                console.error('Error loading comments:', err);
            }
        };

        document.getElementById('commentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const content = document.getElementById('content').value;
            const profilePicture = document.getElementById('profilePicture').value;

            try {
                const response = await fetch('/comments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, content,profilePicture })
                });
                const result = await response.json();
                console.log(result); // Log the response from the server
                if (response.ok) {
                    document.getElementById('username').value = '';
                    document.getElementById('content').value = '';
                    document.getElementById('profilePicture').value = '';
                    loadComments();
                } else {
                    console.error('Error posting comment:', response.statusText);
                }
            } catch (err) {
                console.error('Error posting comment:', err);
            }
        });

        loadComments();
    });
</script>
    
<%- include("partials/UserFooter.ejs") %>
